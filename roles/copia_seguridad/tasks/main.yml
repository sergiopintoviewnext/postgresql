---

#Con el usuario postgres da error, no tiene permisos, se deber√° utilizar un usuario creado previamente.
- name: Crear copia de suguridad
  community.postgresql.postgresql_db:
    name: "{{ item }}"
    state: dump
    target: /var/lib/pgsql/{{ version_postgresql }}/backups/{{ item }}.sql
    login_user: "{{ nombre_usuario }}"
    login_password: "{{ password_usuario }}"
    login_host: "{{ host }}"
  with_items: "{{ db }}"
  changed_when: false


- name: Comprobar ficheros copia de seguridad
  ansible.builtin.stat:
    path: /var/lib/pgsql/{{ version_postgresql }}/backups/{{ item }}.sql
  register: fichero_copia
  with_items: "{{ db }}"


- name: Existe fichero
  ansible.builtin.assert:
    that: item.stat.exists == True
    success_msg: "El fichero {{ item.stat.path }} existe, se ha realizado la copia de seguridad"
    fail_msg: "El fichero {{ item.stat.path }} NO existe, NO se ha realizado la copia de seguridad"
  with_items: "{{ fichero_copia.results }}"

...
